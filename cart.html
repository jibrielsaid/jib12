<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cart - TECHPARTS HUB</title>

<link rel="stylesheet" href="style.css">
<link rel="icon" type="image/jpg" href="image/gus1.jpg">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
    .cart-icon {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 10px 12px;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .cart-icon img {
        width: 30px;
    }

    .cart-item {
        display: flex;
        align-items: center;
        background: white;
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #f0f0f0;
    }

    .cart-item img {
        width: 90px;
        height: 70px;
        object-fit: cover;
        border-radius: 5px;
        margin-right: 15px;
    }

    .cart-item-details {
        flex-grow: 1;
    }

    .remove-btn {
        background: #ff5252;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .remove-btn:hover {
        background: #ff1744;
    }

    .total-box {
        background: #fff;
        padding: 15px;
        margin-top: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #f0f0f0;
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        color: #1a1a1a;
    }

    .checkout-btn {
        display: block;
        width: 200px;
        margin: 20px auto;
        padding: 12px;
        background: #00d4ff;
        color: #111;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        transition: background 0.3s ease;
    }

    .checkout-btn:hover {
        background: #00b8d4;
    }

    .empty-message {
        text-align: center;
        font-size: 18px;
        color: #999;
        margin-top: 40px;
    }

    .back-link {
        display: block;
        text-align: center;
        margin-top: 30px;
        font-size: 16px;
        text-decoration: none;
        color: #00d4ff;
        transition: color 0.3s ease;
    }

    .back-link:hover {
        color: #00b8d4;
    }

    h1 {
        text-align: center;
        margin-top: 20px;
        margin-bottom: 30px;
        color: #1a1a1a;
    }

    .cart-section {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 20px 40px;
    }

    /* Checkout Modal Styles */
    .checkout-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        overflow-y: auto;
    }

    .checkout-modal.active {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 20px;
    }

    .checkout-content {
        background: white;
        border-radius: 12px;
        max-width: 700px;
        width: 100%;
        margin: 20px auto;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        position: relative;
    }

    .close-modal {
        position: absolute;
        top: 15px;
        right: 15px;
        background: transparent;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #666;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.3s;
    }

    .close-modal:hover {
        background: #f0f0f0;
    }

    .checkout-section {
        margin-bottom: 25px;
    }

    .checkout-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #1a1a1a;
        border-bottom: 2px solid #00d4ff;
        padding-bottom: 8px;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .info-label {
        font-weight: 600;
        color: #666;
    }

    .info-value {
        color: #1a1a1a;
        text-align: right;
    }

    .payment-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 15px;
    }

    .payment-option {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        background: white;
    }

    .payment-option:hover {
        border-color: #00d4ff;
        background: #f0f9ff;
    }

    .payment-option.selected {
        border-color: #00d4ff;
        background: #e0f7fa;
    }

    .payment-option input[type="radio"] {
        margin-right: 8px;
    }

    .payment-option label {
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
    }

    .order-summary {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }

    .order-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .order-item:last-child {
        border-bottom: none;
    }

    .order-total {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #00d4ff;
        display: flex;
        justify-content: space-between;
        font-size: 20px;
        font-weight: bold;
        color: #1a1a1a;
    }

    .confirm-checkout-btn {
        width: 100%;
        padding: 15px;
        background: #00d4ff;
        color: #111;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
        transition: background 0.3s;
    }

    .confirm-checkout-btn:hover {
        background: #00b8d4;
    }

    .confirm-checkout-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    @media (max-width: 600px) {
        .checkout-content {
            padding: 20px;
            margin: 10px;
        }

        .payment-options {
            grid-template-columns: 1fr;
        }
    }
</style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar">
    <div class="logo"><h1>TECHPARTS HUB</h1></div>
    <ul class="menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="shop.html">Shop</a></li>
        
        <li><a href="AboutUs.html">About Us</a></li>
        <li><a href="myaccount.html">My Account</a></li>
        <li>
            <a href="cart.html">
                <i class="fa-solid fa-cart-shopping" style="font-size: 22px; color: #00d4ff; margin-left: 10px;"></i>
            </a>
        </li>
        <li id="nav-user" style="display:none;">
            <span id="nav-username" style="color:#333; margin-left:8px;"></span>
            <button id="nav-logout" style="margin-left:8px; background:transparent; border:1px solid rgba(0,0,0,0.1); color:#333; padding:4px 8px; border-radius:4px; cursor:pointer;">Logout</button>
        </li>
    </ul>
    <div class="menu-bnt">
        <i class="fa fa-bars"></i>
    </div>
</nav>

<!-- CART ICON SA TAAS -->
<a href="cart.html" class="cart-icon">
    <img src="https://cdn-icons-png.flaticon.com/512/1170/1170678.png">
</a>

<h1>Your Cart</h1>
<div id="cart-container"></div>

<div id="total" class="total-box"></div>

<button class="checkout-btn" onclick="checkout()">Checkout</button>

<a href="shop.html" class="back-link">← Back to Shop</a>

<!-- Checkout Modal -->
<div id="checkoutModal" class="checkout-modal">
    <div class="checkout-content">
        <button class="close-modal" onclick="closeCheckoutModal()">&times;</button>
        <h2 style="margin-top: 0; margin-bottom: 20px;">Checkout</h2>
        
        <!-- User Information Section -->
        <div class="checkout-section">
            <h3>Customer Information</h3>
            <div id="user-info-container">
                <!-- User info will be populated here -->
            </div>
        </div>

        <!-- Payment Method Section -->
        <div class="checkout-section">
            <h3>Mode of Payment</h3>
            <div class="payment-options">
                <div class="payment-option" onclick="selectPayment('cod')">
                    <label>
                        <input type="radio" name="payment" value="cod" required>
                        <span>Cash on Delivery</span>
                    </label>
                </div>
                <div class="payment-option" onclick="selectPayment('gcash')">
                    <label>
                        <input type="radio" name="payment" value="gcash" required>
                        <span>GCash</span>
                    </label>
                </div>
                <div class="payment-option" onclick="selectPayment('paypal')">
                    <label>
                        <input type="radio" name="payment" value="paypal" required>
                        <span>PayPal</span>
                    </label>
                </div>
                <div class="payment-option" onclick="selectPayment('credit')">
                    <label>
                        <input type="radio" name="payment" value="credit" required>
                        <span>Credit Card</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Order Summary Section -->
        <div class="checkout-section">
            <h3>Order Summary</h3>
            <div class="order-summary" id="order-summary">
                <!-- Order items will be populated here -->
            </div>
        </div>

        <button class="confirm-checkout-btn" id="confirmCheckoutBtn" onclick="confirmCheckout()" disabled>
            Confirm Order
        </button>
    </div>
</div>

<script>
function displayCart() {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    const container = document.getElementById('cart-container');
    const totalBox = document.getElementById('total');

    container.innerHTML = '';
    totalBox.innerHTML = '';

    if (cart.length === 0) {
        container.innerHTML = '<p class="empty-message">Your cart is empty.</p>';
        totalBox.style.display = "none";
        const checkoutBtn = document.querySelector('.checkout-btn');
        if (checkoutBtn) checkoutBtn.style.display = "none";
        return;
    }
    
    // Show checkout button if cart has items
    const checkoutBtn = document.querySelector('.checkout-btn');
    if (checkoutBtn) checkoutBtn.style.display = "block";

    let totalPrice = 0;

    cart.forEach((item, index) => {
        // item.price is the display string (e.g. "$3,500"), item.amount is the numeric value
        let amount = 0;
        if (typeof item.amount === 'number') {
            amount = item.amount;
        } else if (typeof item.price === 'string') {
            // strip all non-numeric/non-dot characters
            const cleaned = item.price.replace(/[^0-9.]/g, '');
            amount = parseFloat(cleaned) || 0;
        }
        
        // Get quantity (default to 1 if not set for backward compatibility)
        const quantity = item.quantity || 1;
        const itemTotal = amount * quantity;
        totalPrice += itemTotal;

        const div = document.createElement('div');
        div.classList.add('cart-item');

        div.innerHTML = `
            <img src="${item.img}" alt="${item.name}">
            <div class="cart-item-details">
                <h3>${item.name}</h3>
                <p>Price: ${item.price} ${quantity > 1 ? `× ${quantity}` : ''}</p>
                ${quantity > 1 ? `<p style="color: #666; font-size: 14px; margin-top: 4px;">Subtotal: $${itemTotal.toLocaleString()}</p>` : ''}
            </div>
            <button class="remove-btn" onclick="removeItem(${index})">Remove</button>
        `;

        container.appendChild(div);
    });

    totalBox.innerHTML = "Total: $" + totalPrice.toLocaleString();
}

function removeItem(index) {
    let cart = JSON.parse(localStorage.getItem('cart'));
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    
    // Save cart to user account
    saveCartToAccount(cart);
    
    displayCart();
}

// Function to save cart to user account
function saveCartToAccount(cart) {
    try {
        const userRaw = localStorage.getItem('user');
        if (!userRaw) return;
        
        const user = JSON.parse(userRaw);
        const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
        
        // Find and update the account in accounts array
        const accountIndex = accounts.findIndex(acc => acc.email && acc.email.toLowerCase() === user.email.toLowerCase());
        if (accountIndex !== -1) {
            accounts[accountIndex].cart = cart;
            localStorage.setItem('accounts', JSON.stringify(accounts));
        }
        
        // Also update current user
        user.cart = cart;
        localStorage.setItem('user', JSON.stringify(user));
    } catch (e) {
        // Ignore errors
    }
}

function checkout() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    
    if (cart.length === 0) {
        alert("Your cart is empty!");
        return;
    }

    // Check if user is logged in
    let user = null;
    try {
        const userRaw = localStorage.getItem('user');
        if (userRaw) {
            user = JSON.parse(userRaw);
        } else {
            // Try to get from session
            const sessionRaw = sessionStorage.getItem('session');
            if (sessionRaw) {
                const session = JSON.parse(sessionRaw);
                const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                const account = accounts.find(acc => acc.email && acc.email.toLowerCase() === session.email.toLowerCase());
                if (account) {
                    user = account;
                }
            }
        }
    } catch (e) {
        console.error('Error loading user:', e);
    }

    if (!user || !user.email) {
        alert("Please login first to checkout!");
        window.location.href = "account.html?next=cart.html";
        return;
    }

    // Populate user information
    populateUserInfo(user);
    
    // Populate order summary
    populateOrderSummary(cart);
    
    // Show modal
    document.getElementById('checkoutModal').classList.add('active');
}

function closeCheckoutModal() {
    document.getElementById('checkoutModal').classList.remove('active');
    // Reset payment selection
    document.querySelectorAll('input[name="payment"]').forEach(radio => {
        radio.checked = false;
    });
    document.querySelectorAll('.payment-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.getElementById('confirmCheckoutBtn').disabled = true;
}

function selectPayment(value) {
    // Uncheck all radios first
    document.querySelectorAll('input[name="payment"]').forEach(radio => {
        radio.checked = false;
    });
    
    // Remove selected class from all options
    document.querySelectorAll('.payment-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Select the clicked option
    const radio = document.querySelector(`input[value="${value}"]`);
    if (radio) {
        radio.checked = true;
        radio.closest('.payment-option').classList.add('selected');
        document.getElementById('confirmCheckoutBtn').disabled = false;
    }
}

function populateUserInfo(user) {
    const container = document.getElementById('user-info-container');
    
    const infoHTML = `
        <div class="info-row">
            <span class="info-label">Full Name:</span>
            <span class="info-value">${user.name || 'Not provided'}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Email:</span>
            <span class="info-value">${user.email || 'Not provided'}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Phone Number:</span>
            <span class="info-value">${user.phone || 'Not provided'}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Address:</span>
            <span class="info-value">${user.address || 'Not provided'}</span>
        </div>
    `;
    
    container.innerHTML = infoHTML;
}

function populateOrderSummary(cart) {
    const container = document.getElementById('order-summary');
    let totalPrice = 0;
    let itemsHTML = '';
    
    cart.forEach(item => {
        let amount = 0;
        if (typeof item.amount === 'number') {
            amount = item.amount;
        } else if (typeof item.price === 'string') {
            const cleaned = item.price.replace(/[^0-9.]/g, '');
            amount = parseFloat(cleaned) || 0;
        }
        
        const quantity = item.quantity || 1;
        const itemTotal = amount * quantity;
        totalPrice += itemTotal;
        
        itemsHTML += `
            <div class="order-item">
                <span>${item.name} ${quantity > 1 ? `× ${quantity}` : ''}</span>
                <span>$${itemTotal.toLocaleString()}</span>
            </div>
        `;
    });
    
    container.innerHTML = itemsHTML + `
        <div class="order-total">
            <span>Total:</span>
            <span>$${totalPrice.toLocaleString()}</span>
        </div>
    `;
}

function confirmCheckout() {
    const selectedPayment = document.querySelector('input[name="payment"]:checked');
    
    if (!selectedPayment) {
        alert("Please select a payment method!");
        return;
    }
    
    const paymentMethod = selectedPayment.value;
    const paymentMethods = {
        'cod': 'Cash on Delivery',
        'gcash': 'GCash',
        'paypal': 'PayPal',
        'credit': 'Credit Card'
    };
    
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    let totalPrice = 0;
    
    cart.forEach(item => {
        let amount = 0;
        if (typeof item.amount === 'number') {
            amount = item.amount;
        } else if (typeof item.price === 'string') {
            const cleaned = item.price.replace(/[^0-9.]/g, '');
            amount = parseFloat(cleaned) || 0;
        }
        const quantity = item.quantity || 1;
        totalPrice += amount * quantity;
    });
    
    // Show confirmation message
    alert(`Order confirmed!\n\nPayment Method: ${paymentMethods[paymentMethod]}\nTotal Amount: $${totalPrice.toLocaleString()}\n\nThank you for your purchase!`);
    
    // Clear cart
    localStorage.removeItem("cart");
    saveCartToAccount([]);
    
    // Close modal
    closeCheckoutModal();
    
    // Refresh cart display
    displayCart();
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('checkoutModal');
    if (event.target === modal) {
        closeCheckoutModal();
    }
});

displayCart();

// Logout functionality
(function(){
    function showUser() {
        let raw = null;
        try { raw = sessionStorage.getItem('session') || localStorage.getItem('user'); } catch(e) { raw = localStorage.getItem('user'); }
        const navUser = document.getElementById('nav-user');
        const navName = document.getElementById('nav-username');
        const logout = document.getElementById('nav-logout');
        if (!navUser || !navName || !logout) return;
        if (raw) {
            let user = raw;
            try { user = JSON.parse(raw); } catch(e){}
            navName.textContent = (user && user.name) ? user.name : 'Account';
            navUser.style.display = '';
        } else {
            navUser.style.display = 'none';
        }

        logout.addEventListener('click', function(){
            // Save current cart to user account before logout
            try {
                const cartRaw = localStorage.getItem('cart');
                if (cartRaw) {
                    const cart = JSON.parse(cartRaw);
                    saveCartToAccount(cart);
                }
            } catch (e) {}
            
            // Remove current user, but keep accounts list for future logins
            localStorage.removeItem('user');
            try { sessionStorage.removeItem('session'); } catch(e){}
            localStorage.removeItem('cart'); // Clear cart on logout
            location.reload();
        });
    }
    document.addEventListener('DOMContentLoaded', showUser);
    showUser();
})();
</script>

</body>
</html>